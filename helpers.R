#### Helper functions ####

#### Utility functions ####
#### Converting HH:MM:SS or MM:SS to a numeric vector of minutes
parse_duration <- function(x){
  mins <- sapply(x, function(x){
            if (str_count(x, ":") == 2) {
              xx      <- as.numeric(unlist(str_split(x, ":")))
              minutes <- xx[1] * 60 + xx[2] + xx[3] / 60
            } else if (str_count(x, ":") == 1) {
              xx      <- as.numeric(unlist(str_split(x, ":")))
              minutes <- xx[1] + xx[2] / 60
            } else {
              stop("Unexpected input format ", x)
            }
            return(unname(minutes))
          })
  mins <- unname(mins)
  return(mins)
}

#### Parse date and times
parse_podcasts_step1 <- function(showstats) {
  showstats %<>%
    filter(!is.na(number)) %>%
    mutate(duration = parse_duration(duration),
           date     = dmy(date),
           year     = as.factor(year(date)),
           month    = month(date, abbr = F, label = T),
           weekday  = wday(date, label = T, abbr = F)) %>%
    select(podcast, number, date, year, month, weekday, everything())
  return(showstats)
}

#### Spread long format
widen_guests <- function(data, concatenate = FALSE) {
  data %<>%
    group_by(number) %>%
    mutate(guest_position = paste0("guest_", 1:length(guest))) %>%
    spread(key = guest_position, value = guest)
  if (concatenate) {
    data %<>%
      unite(guests, contains("guest"), sep = ", ") %>%
      mutate(guests = str_replace_all(guests, ", NA", "")) %>%
      ungroup
  }
  return(data)
}

#### Caching
cache_podcast_data <- function(x, dir = "data", filename = NULL) {
  if (is.null(filename)){
    filename <- deparse(substitute(x))
  }
  path <- paste0(file.path(dir, filename), ".rds")
  message("Saving ", filename, " to ", path)
  saveRDS(x, path)
}

#### Handling the stats.txt ####
#### Initial collection of the stats file
# Thanks a lot, @l3viathan https://twitter.com/L3viathan2142/status/701009923841400833
get_initial_stats <- function(urlpartial = "theincomparable", show_title = "The Incomparable") {
  require(readr)
  require(magrittr)
  require(httr)
  stats_url <- paste0("https://www.theincomparable.com/", urlpartial, "/stats.txt")
  showstats <- readLines(stats_url) %>%
    str_replace_all(',(?=[^"]*"(?:[^"]*"[^"]*")*[^"]*$)', "COMMA") %>%
    str_replace_all('"(?=.*")', "QUOT") %>%
    str_replace("QUOT",'"') %>%
    paste0(collapse = "\n") %>% {
      suppressWarnings(read_csv(file = ., col_names = F, trim_ws = T, col_types = cols(X1 = col_character())))
    } %>%
    filter(!is.na(X1))

  if (ncol(showstats) == 5) {
    names(showstats) <- c("number", "date", "duration", "title", "host")
  } else {
    names(showstats) <- c("number", "date", "duration", "title", "host", paste0("guest", 1:(ncol(showstats) - 5)))
  }
  showstats$podcast <- show_title
  showstats %<>% select(podcast, everything())
  showstats$title  <- str_replace_all(showstats$title, "COMMA", ",")
  showstats$title  <- str_replace_all(showstats$title, "QUOT", "“")

  return(showstats)
}

#### Preparations after initital collection of stats.txt ####
#### Extract host
# Needs work, see issue #1
extract_main_host <- function(showstats) {
  showstats %>% separate(host, into = c("host_1", "host_2", "host_3", "host_4"), sep = "(\\s(and)|with)") %>%
    mutate(host_2 = ifelse(is.na(host_2), "None", host_2),
           host_1 = str_trim(host_1, "both")) %>%
    rename(guest_dummy_1 = host_2,
           guest_dummy_2 = host_3,
           guest_dummy_3 = host_4) %>%
    return()
}

#### Further guest management
fix_guests <- function(showstats){
  if ("guest1" %in% names(showstats)) {
    showstats %<>% separate(guest1, c("guest1_1", "guest1_2"), sep = " and ")
  }
  if ("guest2" %in% names(showstats)) {
    showstats %<>% separate(guest2, c("guest2_1", "guest2_2"), sep = " and ")
  }
  if ("guest3" %in% names(showstats)) {
    showstats %<>% separate(guest3, c("guest3_1", "guest3_2"), sep = " and ")
  }
  if ("guest4" %in% names(showstats)) {
    showstats %<>% separate(guest4, c("guest4_1", "guest4_2"), sep = " and ")
  }
  if ("guest5" %in% names(showstats)) {
    showstats %<>% separate(guest5, c("guest5_1", "guest5_2"), sep = " and ")
  }
  showstats %<>%
    gather(position, guest, contains("guest")) %>%
    filter(!is.na(guest)) %>%
    mutate(guest = str_trim(guest, side = "both")) %>%
    select(-position) %>%
    rename(host = host_1) %>%
    arrange(desc(date))
  return(showstats)
}

#### Compilation of the above functions in one
get_podcast_stats <- function(urlpartial = "theincomparable", show_title = "The Incomparable"){
    get_initial_stats(urlpartial, show_title) %>%
    parse_podcasts_step1() %>%
    extract_main_host() %>%
    fix_guests() %>%
    select(-title) %>%
    full_join(y = get_podcast_metadata(urlpartial),
              by = c("number" = "number")) %>%
    filter(!is.na(podcast))
}

#### Parsing the archive pages ####
#### Getting summaries, topics and categories
get_podcast_metadata <- function(urlpartial = "theincomparable"){
  require(rvest)
  require(dplyr)
  require(stringr)

  url     <- paste0("https://www.theincomparable.com/", urlpartial, "/archive/")

  archive_parsed <- read_html(url)

  entries <- archive_parsed %>%
    html_nodes(css = "#entry") %>%
    html_text()

  epnums <- archive_parsed %>%
    html_nodes(css = ".episode-number") %>%
    html_text() %>%
    as.character()

  summaries <- entries %>%
    str_replace_all("^(\\W)*\\d+(\\W)*", "") %>%
    str_replace_all("^.*\\n(\\n+|\\s+)", "") %>%
    str_replace_all("\\n(\\n+|\\s+|.+|\\w|\\•|\\,|\\d+)+$", "")

  # Possibly smarter solution?
  # summaries <- archive_parsed %>%
  #   html_nodes(css = ".episode-description") %>%
  #   html_text() %>%
  #   str_replace_all("^(\\W)*", "") %>%
  #   str_replace_all("\\W*$", "")

  titles <- archive_parsed %>%
    html_nodes(css = ".entry-title a") %>%
    html_text()

  categories <- entries %>%
    str_replace_all("(\\n|\\s)*$", "") %>%
    str_extract("\\s\\w+$") %>%
    str_trim("both") %>%
    str_replace_all("^(seconds|minute|minutes|hour)$", "Not provided")

  topics <- entries %>%
    str_extract(".* •") %>%
    str_replace_all("•", "") %>%
    str_replace_all("^\\s$", "Not provided") %>%
    str_trim("both")

  result <- data_frame(number = epnums, title = titles, summary = summaries,
                       category = categories, topic = topics)
  return(result)
}
